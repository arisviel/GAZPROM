(*Максимальные и минимальные уставки по КГС*)
Q_KGS_MAX:=Q_SKV1_MAX+Q_SKV2_MAX+Q_SKV3_MAX+Q_SKV4_MAX+Q_SKV5_MAX+Q_SKV6_MAX+Q_SKV7_MAX
Q_KGS_MIN:=Q_SKV1_MIN+Q_SKV3_MIN+Q_SKV3_MIN+Q_SKV4_MIN+Q_SKV5_MIN+Q_SKV6_MIN+Q_SKV7_MIN

(*Задача уставки*)
IF SCADA_QKGST<>SAVE_SCADA_QKGST THEN
    QKGST_OUT:=SCADA_QKGST;
    SAVE_SCADA_QKGST:=SCADA_QKGST;
END_IF;

IF PANEL_QKGST<>SAVE_PANEL_QKGST THEN
    QKGST_OUT:=PANEL_QKGST;
    SAVE_PANEL_QKGST:=PANEL_QKGST;
END_IF; 

IF RESERV_QKGST<>SAVE_RESERV_QKGST THEN
    QKGST_OUT:=RESERV_QKGST;
    SAVE_RESERV_QKGST:=RESERV_QKGST;
END_IF;

SAVEALL_QKGST:=QKGST_OUT;
SCADA_QKGST:=SAVEALL_QKGST;  
PANEL_QKGST:=SAVEALL_QKGST;  
RESERV_QKGST:=SAVEALL_QKGST;

(*проверка корректной уставки*)
IF Q_KGS_MIN>QKGST_OUT THEN
    QKGST_OUT:=Q_KGS_MIN;
    END_IF;

IF Q_KGS_MAX<QKGST_OUT THEN
    QKGST_OUT:=Q_KGS_MAX;
    END_IF;

(* Задача пром переменной, отражающей существование скважины*)
IF QR41 THEN X41:=1; Y41:=0; ELSE X41:=0; Y41:=1; END_IF;
IF QR42 THEN X42:=1; Y42:=0; ELSE X42:=0; Y42:=1; END_IF;
IF QR43 THEN X43:=1; Y43:=0; ELSE X43:=0; Y43:=1; END_IF;
IF QR44 THEN X44:=1; Y44:=0; ELSE X44:=0; Y44:=1; END_IF;
IF QR45 THEN X45:=1; Y45:=0; ELSE X45:=0; Y45:=1; END_IF;
IF QR46 THEN X46:=1; Y46:=0; ELSE X46:=0; Y46:=1; END_IF;
IF QR47 THEN X47:=1; Y47:=0; ELSE X47:=0; Y47:=1; END_IF;

(*Расчет расхода в подрежиме 4*)

QKGS_MAX :=Q_SKV1_MAX*X41+Q_SKV2_MAX*X42+Q_SKV3_MAX*X43+Q_SKV4_MAX*X44
+Q_SKV5_MAX*X45+Q_SKV6_MAX*X46+Q_SKV7_MAX*X47

IF QKGS_MAX=0 THEN QKGS_MAX=1; END_IF;(*защита от деления на 0*).

QKGST:=QKGST_OUT - IAPX21*Y41 - IAPX22*Y42 - IAPX23*Y43 -IAPX24*Y44 -IAPX25*Y45 - IAPX26*Y46 - IAPX27*Y47

Q41:=(QKGST/QKGS_MAX)*Q_SKV1_MAX;
Q42:=(QKGST/QKGS_MAX)*Q_SKV2_MAX;
Q43:=(QKGST/QKGS_MAX)*Q_SKV3_MAX;
Q44:=(QKGST/QKGS_MAX)*Q_SKV4_MAX;
Q45:=(QKGST/QKGS_MAX)*Q_SKV5_MAX;
Q46:=(QKGST/QKGS_MAX)*Q_SKV6_MAX;
Q47:=(QKGST/QKGS_MAX)*Q_SKV7_MAX;

(*задача давления*)
(*Задача уставки*)
IF SCADA_PKGST<>SAVE_SCADA_PKGST THEN
    PKGST_OUT:=SCADA_PKGST;
    SAVE_SCADA_PKGST:=SCADA_PKGST;
END_IF;

IF PANEL_PKGST<>SAVE_PANEL_PKGST THEN
    PKGST_OUT:=PANEL_PKGST;
    SAVE_PANEL_PKGST:=PANEL_PKGST;
END_IF; 

IF RESERV_PKGST<>SAVE_RESERV_PKGST THEN
    PKGST_OUT:=RESERV_PKGST;
    SAVE_RESERV_PKGST:=RESERV_PKGST;
END_IF;

SAVEALL_PKGST:=PKGST_OUT;
SCADA_PKGST:=SAVEALL_PKGST;  
PANEL_PKGST:=SAVEALL_PKGST;  
RESERV_PKGST:=SAVEALL_PKGST;

(*проверка корректной уставки*)
IF P_KGS_MIN>PKGST_OUT THEN
    PKGST_OUT:=P_KGS_MIN;
    END_IF;

IF P_KGS_MAX<PKGST_OUT THEN
    PKGST_OUT:=P_KGS_MAX;
    END_IF;

(*РАСЧЕТ СУММЫ*)
IF ABS (QKGST_OUT-QSUM)<BETTA THEN
    SUM2:=TRUE;
    ELSE
    SUM2:=FALSE;
    END_IF;

IF ABS(PKGST_OUT-PSUM)< DELTA THEN
    SUM1:=TRUE;
    ELSE
    SUM1:=FALSE;
END_IF;
